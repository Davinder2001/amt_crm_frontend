name: Build and Deploy - AMT CRM Frontend

on:
  push:
    branches: [ production ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npx tsc --noEmit

      - name: Build application
        run: npm run build
        timeout-minutes: 15
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}

      - name: Create environment files from secrets
        run: |
          cat > env << EOF
          NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
          EOF
          cat > env.docker << EOF
          NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
          EOF

      - name: Build Docker image
        run: docker build -t amt-crm-frontend .
        timeout-minutes: 10

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r src deployment/
          cp -r public deployment/
          cp package.json deployment/
          cp package-lock.json deployment/
          cp Dockerfile deployment/
          cp docker-compose.yml deployment/
          cp next.config.ts deployment/
          cp tsconfig.json deployment/
          cp .dockerignore deployment/
          cp env deployment/
          cp env.docker deployment/
          tar -czf deployment.tar.gz -C deployment .

      - name: Copy files to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          source: "deployment.tar.gz"
          target: "/srv/amt_crm_frontend"
          overwrite: true

      - name: Deploy with SSH and Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            cd /srv/amt_crm_frontend
            tar -xzf deployment.tar.gz
            chown -R ubuntu:ubuntu /srv/amt_crm_frontend
            chmod -R 755 /srv/amt_crm_frontend
            
            echo "ðŸ§¹ Stopping only frontend container..."
            docker stop amt_crm_frontend || true
            docker rm -f amt_crm_frontend || true
            
            echo "ðŸ—‘ï¸ Removing frontend image only..."
            docker rmi amt_crm_frontend:latest || true
            docker rmi amt-crm-frontend:latest || true
            
            echo "ðŸ”¨ Building fresh frontend image with no cache..."
            docker compose build --no-cache --pull frontend
            
            echo "ðŸš€ Starting frontend container..."
            docker compose up -d frontend
            
            echo "â³ Waiting for frontend container to start..."
            sleep 30
            
            if ! docker ps | grep -q "amt_crm_frontend"; then
              echo "âŒ Frontend container is not running. Checking logs..."
              docker logs amt_crm_frontend
              exit 1
            fi
            echo "âœ… Frontend deployment completed successfully!"
            echo "ðŸŒ Your frontend is available at: http://himmanav.com:3000"